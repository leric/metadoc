## 产品需求文档：Airic CLI MVP

**版本:** 1.0
**日期:** 2024-05-24

### 1. 概述

**1.1 产品目标**
Airic旨在成为用户的个人AI工作搭档，通过创新的“元文档（Meta Document）”和“引导式问题拆解”理念，实现更紧密、更自然的人机协作。

**1.2 MVP目标**
此CLI（命令行界面）MVP的核心目标是**验证“一切皆是文档”的核心机制的可行性与初步有效性**。具体包括：

*   验证使用Markdown和元数据（Metadata）定义Agent、文档类型（DocType）和工作流（Workflow）的可行性与便捷性。
*   测试系统基于当前活动文档及其链接关系，自动加载相关上下文（短期记忆）的能力。
*   初步实现AI基于加载的上下文，提供基础的问答、内容生成、思考辅助等能力。
*   使开发团队能够在**实际工作场景**中使用该MVP（Dogfooding），收集反馈，迭代核心机制和基础元文档定义。
*   **明确排除：** 本MVP阶段**不**关注用户体验优化、图形界面、实时协作、复杂的Agent调度或自动化执行。用户需配合外部文本编辑器使用。

**1.3 目标用户 (MVP阶段)**
内部开发团队成员。

**1.4 核心理念重申**
*   **元文档 (Meta Document):** 文档是驱动AI工作的“源代码”和人机共享的“大脑”。
*   **一切皆是文档:** Agent行为、任务流程、文档规范等均通过特定结构的Markdown文档定义。
*   **上下文感知:** AI能够基于用户当前工作的文档及其关联信息理解上下文。
*   **人机协作:** 重点在于AI辅助人类思考和执行，而非完全自动化。

### 2. 系统设计与技术选型

**2.1 核心架构: "一切皆是文档"**
*   **知识库:** 本地文件系统中的一个指定目录（项目工作区），包含树形结构的Markdown (`.md`) 文件。
*   **定义驱动:** 系统行为（如特定文档关联的AI能力、工作流步骤）由工作区内特定路径或元数据标记的Markdown文档定义。
*   **技术栈:**
    *   **语言:** Python 3.12
    *   **AI模型交互:** Google ADK
    *   **CLI框架:** `typer` (用于构建命令行入口和参数解析)
    *   **交互式CLI:** `prompt-toolkit` + `rich` (用于实现交互式命令行界面，支持历史记录、自动补全等)
    *   **Markdown解析:** `markdown2`解析markdown，配合`frontmatter`库处理YAML frontmatter

**2.2 关键数据结构**
*   **Markdown文档:**
    *   **内容:** 标准Markdown语法。
    *   **元数据 (Metadata):** 使用YAML Frontmatter格式在文档开头定义键值对（例如 `agent: writer`, `doctype: meeting_minutes`, `status: wip`）。
    *   **链接:** 支持WikiLink风格的内部链接 (`[[目标文档名]]` 或 `[[/绝对路径/目标文档名]]`)，用于关联文档和表示任务分解。
*   **定义文档:** 特定路径下的Markdown文件（例如 `.airic/meta/agents/my_agent.md`），其内容和元数据定义了Agent、DocType或Workflow的行为。
*   **会话历史:** 与每个文档关联的对话记录，需要持久化存储（`.airic` 目录下的sqlite数据库文件）。

### 3. 功能需求 (Functional Requirements)

**3.1 初始化与工作区管理**
*   `FR1.1`: 用户可以通过`airic init <directory>`命令初始化一个新的Airic工作区。该命令应创建必要的子目录结构（如 `.airic/meta/agents`, `.airic/meta/doctypes`, `.airic/history`）。
*   `FR1.2`: CLI启动时需要指定或自动检测当前所在的工作区（根目录）。所有操作均基于此工作区。

**3.2 CLI交互界面 (Typer, Prompt-toolkit, Rich)**
*   `FR2.1`: 提供一个持续运行的交互式命令行界面（REPL）。
*   `FR2.2`: 支持命令历史记录（上下箭头导航）。
*   `FR2.3`: 实现命令输入（以 `/` 开头）和自由文本输入（发送给AI）。
*   `FR2.4`: 使用`rich`库格式化输出：
    *   AI的Markdown响应应尽可能渲染（支持标题、列表、粗体、斜体、代码块等）。
    *   代码块应有语法高亮。
    *   系统消息（如错误、状态更新）应清晰可辨。

**3.3 文档导航与管理**
*   `FR3.1`: CLI启动时或通过`/open`命令后，需要明确显示当前活动的文档上下文（例如，在提示符中显示当前文档路径）。默认可设定为工作区根目录下的`README.md`或`index.md`。
*   `FR3.2`: 实现 `/open <document_path_or_link>` 命令：
    *   参数可以是相对路径或绝对路径（相对于工作区根目录）。
    *   参数也可以是当前文档中存在的 `[[WikiLink]]` 目标名称。
    *   命令执行后，将目标文档设置为当前活动文档，并加载其上下文。
*   `FR3.3`: `/open` 命令的自动补全 (`Tab`键)：
    *   应列出当前目录下及子目录下的 `.md` 文件。
    *   应解析当前活动文档中的 `[[WikiLink]]`，并将链接目标（即使文件尚不存在）加入补全列表。
*   `FR3.4`: 不带参数的 `/open` 命令实现reload：
    *   强制重新加载当前活动文档的内容和元数据。
    *   提示用户此操作是因为外部编辑器修改后需要手动同步。
*   `FR3.5`: 当用户通过 `/open [[non_existent_link]]` 尝试导航到一个不存在的链接目标时，系统应自动创建这个文件，并切换当前文件为这个新文件，允许用户开始与其相关的对话。
*   `FR3.6`: CLI交互界面应包含一个状态栏，显示当前活动文档，当前的Agent，当前的DocType

**3.4 元文档处理与上下文加载**
*   `FR4.1`: 系统需要能够解析Markdown文档的YAML Frontmatter，提取元数据键值对。
*   `FR4.2`: 系统需要能够识别文档内容中的 `[[WikiLink]]`。
*   `FR4.3`: 当切换活动文档或执行 `/open` 时，系统需要加载**上下文信息**，至少包括：
    *   当前活动文档的完整内容。
    *   当前活动文档的元数据。
    *   近期会话历史以及相关的文档名称
    *   (可选，MVP初期可简化) 当前活动文档中直接链接 (`[[link]]`) 的其他文档的信息，在Agent认为需要时，使用工具去读取。
*   `FR4.4`: 定义系统如何确定“近期活跃文档”以辅助更广泛的上下文理解（此项在MVP中优先级较低，核心是当前文档上下文）。

**3.5 AI交互与辅助 (Google ADK)**
*   `FR5.1`: 当用户输入非命令文本时，将其作为用户消息发送给AI模型（通过Google ADK）。
*   `FR5.2`: 发送给AI的请求**必须**包含根据`FR4.3`加载的上下文信息（打包进System Prompt或作为用户消息的一部分）。
*   `FR5.3`: **根据当前文档元数据驱动AI行为：**
    *   如果文档元数据包含 `agent: <agent_name>`，系统应查找对应的Agent定义文档 (`.airic/meta/agents/<agent_name>.md`)。定义文档中应包含指导该Agent行为的System Prompt、可用工具列表（MVP阶段可暂不实现工具调用）等信息。这些信息需用于配置对AI模型的调用。
    *   如果文档元数据包含 `doctype: <doctype_name>`，系统应查找对应的DocType定义文档 (`.airic/meta/doctypes/<doctype_name>.md`)。定义文档中可包含格式规范、内容要求等。AI应被告知需遵循这些规范进行回应或辅助写作。
    *   如果文档元数据两者都有，需结合使用。如果都没有，则使用默认的基础AI配置。
*   `FR5.4`: AI的响应需要通过`rich`进行格式化显示。建议的文档编辑部分以markdown形式输出，方便用户复制到编辑器中。
*   `FR5.5`: 与每个文档关联的会话历史需要被记录和持久化，并在后续与该文档相关的交互中作为上下文提供给AI。


**3.6 定义Agent、DocType、Workflow (核心验证点)**
*   `FR6.1`: 用户能够在 `.airic/meta/agents/` 目录下创建/编辑 `.md` 文件来定义自定义Agent。定义文档至少需要支持：
    *   `name:` (元数据) Agent名称
    *   `description:` (元数据) Agent功能描述
    *   文档内容部分作为该Agent的 **System Prompt**。
    *   (未来扩展) `tools:` (元数据) 可用工具列表
*   `FR6.2`: 用户能够在 `.airic/meta/doctypes/` 目录下创建/编辑 `.md` 文件来定义自定义文档类型。定义文档至少需要支持：
    *   `name:` (元数据) DocType名称
    *   `description:` (元数据) 文档类型描述
    *   文档内容部分描述该文档类型的 **规范、模板或要求**。
*   `FR6.3`: 用户能够在 `.airic/meta/workflows/` 目录下创建/编辑 `.md` 文件来定义简单工作流。定义文档至少需要支持：
    *   `name:` (元数据) Workflow名称
    *   `description:` (元数据) Workflow目标描述
    *   文档内容部分**描述工作流的执行步骤**。
    *   注意：工作流也是一种doctype，会在metadata中的doctype字段引用。
*   ~~`FR6.4`: 实现 `/definitions reload` 命令，用于手动加载或重新加载所有定义文件。CLI启动时也应自动加载一次。~~
*   `FR6.5`: 系统需要能够解析这些定义文档，并在AI交互 (`FR5.3`) 或特定命令中（见`FR6.6`）使用这些定义。

### 4. 非功能需求 (Non-Functional Requirements)

*   `NFR1`: **性能:** CLI启动、命令响应、文档加载应在可接受范围内（对于内部使用）。AI响应时间主要取决于模型和网络。
*   `NFR2`: **可靠性:** Markdown解析、元数据提取、链接识别应准确。能处理基本的无效格式或文件丢失情况（报错提示）。
*   `NFR3`: **易用性 (内部):** 命令设计直观，帮助信息清晰。`rich`输出提高可读性。
*   `NFR4`: **可维护性:** 代码结构清晰，遵循Python最佳实践，有适当的注释。

### 5. MVP范围与限制

*   **用户界面:** 纯CLI，无GUI。
*   **编辑器:** 不包含内置编辑器，强依赖外部文本编辑器（如VS Code, Vim, Obsidian等）。
*   **同步:** 需要手动执行 `/open` 命令来让Airic感知外部文件的修改。
*   **协作:** 不支持多人实时协作。
*   **Agent能力:** 仅支持基于System Prompt和上下文的对话交互，暂不支持外部工具调用或复杂的Agent编排。
*   **错误处理:** 提供基础的错误提示，非全面健壮。
*   **安全性:** 内部工具，暂不考虑复杂的用户认证和权限管理。
*   **上下文窗口:** 可能受限于底层AI模型的Token限制，对能加载的上下文（如链接文档数量/深度）可能需要做限制。

### 6. 未来考虑 (Post-MVP)

*   开发集成编辑器的桌面应用 (Electron, Tauri等)。
*   实现更流畅的实时/半实时文档同步。
*   实现MCP外部工具调用和Workflow自动化执行。
*   增强上下文管理，支持更智能的知识检索和关联。
*   引入可视化元素（看板、思维导图等），由文档驱动生成。
*   构建定义文档的分享和发现机制。
*   优化AI引导式问题拆解的交互体验。

